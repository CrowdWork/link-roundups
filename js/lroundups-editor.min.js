!function(){var a=jQuery,b="roundup",c=LR.Modal.extend({content:"",addedPosts:new Backbone.Collection,actions:{Save:"save",Close:"close"},events:{"click .add":"addPost","click .remove":"removePost"},render:function(){var b=_.template(a("#lroundups-posts-tmpl").html());return this.content=b({title:this.title}),LR.Modal.prototype.render.apply(this,arguments),this.renderAdded(),this.renderAvailable(),this.connectSortables(),this},renderAvailable:function(){if(this.posts.length<=0)return!1;var b=_.template(a("#lroundups-post-tmpl").html()),c=b({posts:this.posts});this.$el.find(".available-posts").html(c),this.setupTypehead()},renderAdded:function(){if(this.addedPosts.length<=0)return this.$el.find(".added-posts").html('<li class="no-posts">No posts found.</li>'),!1;var b=_.template(a("#lroundups-post-tmpl").html()),c=b({posts:this.addedPosts});this.$el.find(".added-posts").html(c)},connectSortables:function(){var b=this;this.$el.find(".sortable").sortable({connectWith:".connected",placeholder:"ui-state-highlight"}),this.$el.find(".sortable").on("sortreceive",function(c,d){var e,f=a(c.target),g=d.item;f.hasClass("added-posts")?(f.find(".no-posts").remove(),e=b.posts.findWhere({ID:g.data("id")}),b.addedPosts.add([e]),b.posts.remove([e]),b.renderAdded()):f.hasClass("available-posts")&&(e=b.addedPosts.findWhere({ID:g.data("id")}),b.posts.add([e]),b.addedPosts.remove([e]))})},addPost:function(b){var c=this,d=a(b.currentTarget),e=c.posts.findWhere({ID:d.data("id")});return c.addedPosts.add([e]),c.renderAdded(),!1},removePost:function(b){a(b.currentTarget);return!1},setupTypehead:function(){var b=this,c=["post_title","post_content","post_excerpt"];b.$el.find(".typeahead").typeahead({minLength:3,highlight:!0},{name:"posts",source:function(a,d,e){var f={};a=a.toLowerCase(),b.posts.each(function(b){_.each(c,function(c,d){b.get(c).toLowerCase().indexOf(a)>=0&&(f[b.get("ID")]||(f[b.get("ID")]=b))})}),b.filterList(f)}}),b.$el.find(".typeahead").on("input",function(){""==a(this).val()&&b.$el.find(".available-posts li").show()})},filterList:function(b){var c=this,d=_.keys(b);c.$el.find(".available-posts li").hide(),c.$el.find(".available-posts li").each(function(){_.indexOf(d,String(a(this).data("id")))>=0&&a(this).show()})}});wp.mce.roundup={shortcode_data:{},template:_.template('<div class="lr-block"><% if (typeof name !== "undefined" ) { %><%= name %><% } else { %>Link Roundup Block<% } %></div>'),getContent:function(){var a=this.shortcode.attrs.named;return a.innercontent=this.shortcode.content,this.template(a)},edit:function(a,c){var d=wp.shortcode.next(b,a),e=d.shortcode.attrs.named;e.innercontent=d.shortcode.content,wp.mce.roundup.fetchStories(tinyMCE.activeEditor,e)},fetchStories:function(b,c){var d=this;d.values=c,a.ajax({url:ajaxurl,dataType:"json",data:{action:"roundup_block_posts"},success:d.setupModal.bind(d)})},setupModal:function(a){var b=this;"undefined"==typeof b.modal&&(b.modal=new c),b.modal.posts=new Backbone.Collection(a),b.modal.title=b.values.name,b.modal.render()}},a(document).ready(function(){a.getScript(LR.plugin_url+"/js/vendor/typeahead.js/dist/typeahead.jquery.min.js",function(){wp.mce.views.register(b,wp.mce.roundup)})})}();