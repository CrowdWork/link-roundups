!function(){var a=jQuery,b="roundup_block",c=LR.Modal.extend({content:"",searchFields:["post_title","post_content","post_excerpt"],addedPosts:new Backbone.Collection,actions:{Save:"save",Close:"close"},events:{"click .remove":"removePost","click .close":"close"},render:function(){var b=this,c=_.template(a("#lroundups-posts-tmpl").html()),d=[];if(this.content=c({name:this.name}),LR.Modal.prototype.render.apply(this,arguments),this.showSpinner(),!(this.posts.length<=0)){if("undefined"!=typeof this.ids){var e=this.ids.split(",");_.each(e,function(a,c){var e=b.posts.findWhere({ID:Number(a)});e&&d.push(e)})}return d.length>0&&(this.addedPosts.add(d),this.posts.remove(d)),this.renderAdded(),this.renderAvailable(),this.setupTypehead(),this.connectSortables(),this.hideSpinner(),this}},save:function(c){var d=_.map(this.$el.find(".added-posts li"),function(b,c){return a(b).data("id")}),e="["+b+' ids="'+d.join(",")+'" name="'+this.name+'"]';this.editor.insertContent(e),this.editor.focus(),this.close()},renderAvailable:function(){if(this.posts.length<=0)return!1;this.$el.find(".loading").remove();var b=_.template(a("#lroundups-post-tmpl").html()),c=b({posts:this.posts});this.$el.find(".available-posts").html(c),"undefined"!=typeof this.lastQuery&&this.lastQuery&&this.queryCallback(this.lastQuery)},renderAdded:function(){if(this.addedPosts.length<=0)return this.$el.find(".added-posts").html('<li class="no-posts">No items have been added.</li>'),!1;var b=_.template(a("#lroundups-post-tmpl").html()),c=b({posts:this.addedPosts});this.$el.find(".added-posts").html(c)},connectSortables:function(){var b=this;this.$el.find(".sortable").sortable({connectWith:".connected",placeholder:"ui-state-highlight"}),this.$el.find(".sortable").on("sortstart",function(b,c){a("body").addClass("sorting")}),this.$el.find(".sortable").on("sortdeactivate",function(b,c){a("body").removeClass("sorting")}),this.$el.find(".sortable").on("sortreceive",function(c,d){var e,f=a(c.target),g=d.item;f.hasClass("added-posts")?(f.find(".no-posts").remove(),e=b.posts.findWhere({ID:g.data("id")}),b.addedPosts.add([e]),b.posts.remove([e]),b.renderAdded()):f.hasClass("available-posts")&&(e=b.addedPosts.findWhere({ID:g.data("id")}),b.posts.add([e]),b.addedPosts.remove([e]))})},addPost:function(b){var c=this,d=a(b.currentTarget),e=c.posts.findWhere({ID:d.data("id")});return c.addedPosts.add([e]),!1},removePost:function(b){var c=a(b.currentTarget),d=this.addedPosts.findWhere({ID:c.data("id")}),e=c.closest("li");return this.posts.add([d]),this.addedPosts.remove([d]),this.renderAvailable(),e.remove(),!1},setupTypehead:function(){var b=this;b.$el.find(".typeahead").typeahead({minLength:3,highlight:!0},{name:"posts",source:b.queryCallback.bind(b)}),b.$el.find(".typeahead").removeAttr("disabled"),b.$el.find(".typeahead").on("input",function(){""==a(this).val()&&(b.$el.find(".available-posts li").show(),b.lastQuery=null)})},queryCallback:function(a,b,c){var d=this,e={};a=a.toLowerCase(),d.posts.each(function(b){_.each(d.searchFields,function(c,d){b.get(c).toLowerCase().indexOf(a)>=0&&(e[b.get("ID")]||(e[b.get("ID")]=b))})}),d.filterList(e),d.lastQuery=a},filterList:function(b){var c=this,d=_.keys(b);c.$el.find(".available-posts li").hide(),c.$el.find(".available-posts li").each(function(){_.indexOf(d,String(a(this).data("id")))>=0&&a(this).show()})}});wp.mce.roundup_block={template:_.template('<div class="lr-block"><% if (typeof name !== "undefined" ) { %><%= name %><% } else { %>Link Roundup Block<% } %></div>'),getContent:function(){var a=this.shortcode.attrs.named;return a.innercontent=this.shortcode.content,this.template(a)},edit:function(a,c){var d=wp.shortcode.next(b,a),e=d.shortcode.attrs.named;wp.mce.roundup_block.fetchStories(tinyMCE.activeEditor,e)},fetchStories:function(b,c){var d=this,e=[];d.values=c,d.editor=b,"undefined"!=typeof c.ids&&(e=c.ids.split(",")),d.setupModal(),a.ajax({url:ajaxurl,dataType:"json",method:"post",data:{action:"roundup_block_posts",existingIds:e,security:LR.ajax_nonce},success:function(a){d.modal.posts.reset(a)}})},setupModal:function(a){this.modal=new c,this.modal.posts=new Backbone.Collection(a),this.modal.posts.comparator="order",this.modal.posts.on("reset",this.modal.render.bind(this.modal)),this.modal.addedPosts=new Backbone.Collection,this.modal.name=this.values.name,this.modal.ids=this.values.ids,this.modal.editor=this.editor,this.modal.render()}},a(document).ready(function(){a.getScript(LR.plugin_url+"/js/vendor/typeahead.js/dist/typeahead.jquery.min.js",function(){wp.mce.views.register(b,wp.mce.roundup_block)})})}();