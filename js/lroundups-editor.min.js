!function(){var a=jQuery,b="roundup_block",c=Backbone.Model.extend({saving:!1,save:function(b,c){var d=this;return this.saving?!1:("undefined"!=typeof b&&this.set(b),this.saving=!0,void a.ajax({url:ajaxurl,dataType:"json",method:"post",data:{action:"roundup_update_post",security:LR.ajax_nonce,post:JSON.stringify(this.toJSON())},success:function(a){d.saving=!1,"undefined"!=typeof c.success&&c.success(this)}}))}}),d=Backbone.Collection.extend({model:c}),e=LR.Modal.extend({className:"link-edit-modal",content:"",actions:{Update:"update",Cancel:"close"},initialize:function(a){this.controller=a.controller,LR.Modal.prototype.initialize.apply(this,arguments)},render:function(){var b=_.template(a("#lroundups-post-edit-tmpl").html());return this.content=b(this.model.toJSON()),LR.Modal.prototype.render.apply(this,arguments),this},close:function(){return this.model.saving?!1:void LR.Modal.prototype.close.apply(this,arguments)},update:function(){if(this.model.saving)return!1;var a=this,b=this.$el.find(":input").serializeObject();return this.disableActions(),this.showSpinner(),this.model.save(b,{success:function(){a.hideSpinner(),a.close(),a.controller.renderAdded()}}),!1},disableActions:function(){this.$el.find(".lroundups-modal-actions .button").addClass("disabled")}}),f=LR.Modal.extend({className:"roundup-block-modal",content:"",searchFields:["post_title","post_content","post_excerpt"],addedPosts:new d,actions:{Save:"save",Close:"close"},events:{"click .remove":"removePost","click .close":"close","click .edit":"editLink"},render:function(){var b=this,c=_.template(a("#lroundups-posts-tmpl").html()),d=[];if(this.content=c({name:this.name,hasPosts:"undefined"!=typeof this.ids}),LR.Modal.prototype.render.apply(this,arguments),this.showSpinner(),!(this.posts.length<=0)){if("undefined"!=typeof this.ids){var e=this.ids.split(",");_.each(e,function(a,c){var e=b.posts.findWhere({ID:Number(a)});e&&d.push(e)})}return d.length>0&&(this.addedPosts.add(d),this.posts.remove(d)),this.renderAdded(),this.renderAvailable(),this.setupTypehead(),this.connectSortables(),this.hideSpinner(),this}},save:function(c){var d=_.map(this.$el.find(".added-posts li"),function(b,c){return a(b).data("id")}),e="["+b+' ids="'+d.join(",")+'" name="'+this.name+'"]';this.editor.insertContent(e),this.editor.focus(),this.close()},renderAvailable:function(){if(this.posts.length<=0)return!1;this.$el.find(".loading").remove();var b=_.template(a("#lroundups-post-tmpl").html()),c=b({posts:this.posts});this.$el.find(".available-posts").html(c),"undefined"!=typeof this.lastQuery&&this.lastQuery&&this.queryCallback(this.lastQuery)},renderAdded:function(){if(this.addedPosts.length<=0)return this.$el.find(".added-posts").html('<li class="no-posts">No items have been added.</li>'),!1;var b=_.template(a("#lroundups-post-tmpl").html()),c=b({posts:this.addedPosts});this.$el.find(".added-posts").html(c)},connectSortables:function(){this.$el.find(".sortable").sortable({connectWith:".connected",placeholder:"ui-state-highlight",forcePlaceholderSize:!0}),this.$el.find(".sortable").on("sortstart",function(b,c){a("body").addClass("sorting")}),this.$el.find(".sortable").on("sortdeactivate",function(b,c){a("body").removeClass("sorting")}),this.$el.find(".sortable").on("sortreceive",this.sortReceive.bind(this)),this.$el.find(".sortable.added-posts").on("sortstop",this.sortStop.bind(this))},sortReceive:function(b,c){var d,e=this,f=a(b.target),g=c.item;f.hasClass("added-posts")?(f.find(".no-posts").remove(),d=e.posts.findWhere({ID:g.data("id")}),e.addedPosts.add([d]),e.posts.remove([d]),e.renderAdded()):f.hasClass("available-posts")&&(d=e.addedPosts.findWhere({ID:g.data("id")}),e.posts.add([d]),e.addedPosts.remove([d]))},sortStop:function(b,c){var d=this,e=(a(b.target),c.item),f=e.parent().find("li").index(e);post=d.addedPosts.findWhere({ID:e.data("id")}),d.addedPosts.remove([post],{silent:!0}),d.addedPosts.add([post],{at:f})},editLink:function(b){var c=this,d=a(b.currentTarget),f=c.addedPosts.findWhere({ID:d.data("id")}),g=new e({model:f,controller:this});return g.render(),!1},addPost:function(b){var c=this,d=a(b.currentTarget),e=c.posts.findWhere({ID:d.data("id")});return c.addedPosts.add([e]),!1},removePost:function(b){var c=a(b.currentTarget),d=this.addedPosts.findWhere({ID:c.data("id")}),e=c.closest("li");return this.posts.add([d]),this.addedPosts.remove([d]),this.renderAvailable(),e.remove(),!1},setupTypehead:function(){var b=this;b.$el.find(".typeahead").typeahead({minLength:3,highlight:!0},{name:"posts",source:b.queryCallback.bind(b)}),b.$el.find(".typeahead").removeAttr("disabled"),b.$el.find(".typeahead").on("input",function(){""==a(this).val()&&(b.$el.find(".available-posts li").show(),b.lastQuery=null)})},queryCallback:function(a,b,c){var d=this,e={};a=a.toLowerCase(),d.posts.each(function(b){_.each(d.searchFields,function(c,d){b.get(c).toLowerCase().indexOf(a)>=0&&(e[b.get("ID")]||(e[b.get("ID")]=b))})}),d.filterList(e),d.lastQuery=a},filterList:function(b){var c=this,d=_.keys(b);c.$el.find(".available-posts li").hide(),c.$el.find(".available-posts li").each(function(){_.indexOf(d,String(a(this).data("id")))>=0&&a(this).show()})}});wp.mce.roundup_block={template:_.template('<div class="lr-block"><% if (typeof name !== "undefined" ) { %><%= name %><% } else { %>Link Roundup Block<% } %></div>'),getContent:function(){var a=this.shortcode.attrs.named;return a.innercontent=this.shortcode.content,this.template(a)},edit:function(a,c){var d=wp.shortcode.next(b,a),e=d.shortcode.attrs.named;wp.mce.roundup_block.fetchStories(tinyMCE.activeEditor,e)},fetchStories:function(b,c){var d=this,e=[];d.values=c,d.editor=b,"undefined"!=typeof c.ids&&(e=c.ids.split(",")),d.setupModal(),a.ajax({url:ajaxurl,dataType:"json",method:"post",data:{action:"roundup_block_posts",existingIds:e,security:LR.ajax_nonce},success:function(a){d.modal.posts.reset(a)}})},setupModal:function(a){this.modal=new f,this.modal.posts=new d(a),this.modal.posts.comparator="order",this.modal.posts.on("reset",this.modal.render.bind(this.modal)),this.modal.addedPosts=new d,this.modal.name=this.values.name,this.modal.ids=this.values.ids,this.modal.editor=this.editor,this.modal.render()}},a(document).ready(function(){wp.mce.views.register(b,wp.mce.roundup_block)})}();